# ELB

## Types
**ALB**  
- Can route requests based on the path in the url (layer 7) *www.example.com/pathexample*
- Host-based routing is also possible (based on the host field in HTTP header -> sends it to specified target group) *hostexample.example.com*
  
**NLB**  
- NLB nodes can have *elastic IPs* in each subnet
- The nodes in each subnet are the targets. These forward the requests to the instances in that subnet.
- Its layer 4 (IP protocol) so it can have a listener for different ports. (TCP / port 80 for HTTP routing - HTTP is layer 7, so that doesnt work!)
- Targets can be outside of VPC (on-premises)
- Targets can be EC2 instances or an IP Address

**Cross-Zone load balancing** is enabled for ALB by default. It helps evenly spread out the load between instances in different AZs. It is disabled for NLB's by default.  
  
ALBs make a new connection to the instances, so SSL/TLS makes a new connection and needs a new certificate to make another secure connection. You can use ACM (AWS Certificate Manager) to add a certificate to both and enable end-to-end encryption. This is called a **Secure Listener**. You then need to set up the routing via Route53.  
  
You can use **Lifecycle Hooks** to add user data (script to run on launch) and other actions that need to happen when an instance is launched by the ASG.  
  
## Sessions
- **Session-State Store** Store sessioin data in another resource (DynamoDB, ElastiCache or sometimes S3). If an instance fails, the users authentication isn't lost and he doesn't need to re-authenticate.
- **Sticky Sessions** When a client connects, a cookie is generated and bounds the client to an instance for cookie lifetime. Data is stored locally, so if an instance fails, the data is lost. You can enable stickiness based on a cookie generated by the Load Balancer or by the application and set up the duration.
  
It's possible to use Sticky Sessions and store that date in another resource (so essentially combining both types).  
  
## Load Balancing Algorithms
- **Round Robin** default setting, just spreads all requests evenly over all targets.
- **Least Outstanding Requests** Fills up the target with the least amount of requests open. Keeping the workload evenly spread across targets instead of just dividing the workload. Can't combine with slow start duration attribute.
  
You can also add a **Deregistration delay** - Time to wait for requests to complete before deregistering a target - and **Slow Start duration** - during this period, newly registered targets receive more requests until it's at the same level.

## Architecture Patterns
- **High Availability and Elastic Scalability for web servers** - Use EC2 auto scaling and an ALB across multiple AZ's
- **Low-latency connections over UDP for a game** - Use a NLB with a UDP listener
- **Clients need to whitelist static IP addresses for a highly available load balanced app in an AWS Region** - NLB and create static IP addresses in each AZ. *you cannot assign static IP's to ALB!!* 
- **Application on EC2 in an ASG requires disaster recovery across regions** - You can't create ASG across regions! Create a new ASG in second region with capacity set to 0 (no instances running). Take snapshots and copy them across Regions (via Lambda or Data Lifecycle Manager (DLM) to automate that)
- **Application on EC2 must scale in larger increments if a big increase in traffic occurs, compared to small increases in traffic** - Use auto scaling with a Step Scaling policy and configure a larger capacity increase.
- **Need to scale EC2 instances behind ALB based on the number of requests completed by each instance** - Configure target tracking policy using the ALBRequestCountPerTarget metric.

# Todo
- Try to set up an NLB that is targetting 2 ALBs (look into sticky sessions and static IPs)